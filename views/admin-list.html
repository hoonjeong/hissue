<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 - HI! ISSUE!</title>
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5588520972347187"
     crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>HI! ISSUE! 관리자</h1>
            <a href="/admin/logout" class="logout-btn">로그아웃</a>
        </header>

        <div class="admin-controls">
            <div class="admin-search">
                <form action="/admin/list" method="get">
                    <input type="text" name="search" value="<%= search %>" placeholder="제목 검색">
                    <button type="submit">검색</button>
                </form>
            </div>
            <div class="admin-actions">
                <button id="forceUpdateBtn" class="btn-update" onclick="forceUpdate()">
                    <span id="updateText">강제 업데이트 실행</span>
                    <span id="updateLoader" style="display:none;">업데이트 중...</span>
                </button>
            </div>
        </div>

        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>제목</th>
                    <th>작성시간</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <% contents.forEach(function(content) { %>
                    <tr>
                        <td><%= content.id %></td>
                        <td><%= content.subject %></td>
                        <td><%= new Date(content.insert_time).toLocaleString('ko-KR') %></td>
                        <td>
                            <a href="/admin/edit/<%= content.id %>" class="btn-edit">수정</a>
                            <form action="/admin/delete/<%= content.id %>" method="post" style="display:inline;" 
                                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
                                <button type="submit" class="btn-delete">삭제</button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>

        <!-- 최근 댓글 섹션 -->
        <div class="admin-comments-section">
            <h2>최근 댓글 관리</h2>
            <div id="recentComments" class="recent-comments-list">
                <p>댓글을 불러오는 중...</p>
            </div>
        </div>
    </div>
    
    <script>
        async function forceUpdate() {
            const btn = document.getElementById('forceUpdateBtn');
            const updateText = document.getElementById('updateText');
            const updateLoader = document.getElementById('updateLoader');
            
            if (confirm('정말로 강제 업데이트를 실행하시겠습니까?\n이 작업은 시간이 걸릴 수 있습니다.')) {
                btn.disabled = true;
                updateText.style.display = 'none';
                updateLoader.style.display = 'inline';
                
                try {
                    const response = await fetch('/admin/force-update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`업데이트가 완료되었습니다!\n새로운 콘텐츠: ${result.newCount}개\n업데이트된 콘텐츠: ${result.updatedCount}개`);
                        location.reload();
                    } else {
                        alert('업데이트 중 오류가 발생했습니다: ' + (result.error || '알 수 없는 오류'));
                    }
                } catch (error) {
                    alert('업데이트 요청 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    btn.disabled = false;
                    updateText.style.display = 'inline';
                    updateLoader.style.display = 'none';
                }
            }
        }

        // 최근 댓글 로드
        async function loadRecentComments() {
            try {
                const response = await fetch('/admin/api/recent-comments');
                const data = await response.json();
                
                if (data.success && data.comments) {
                    const container = document.getElementById('recentComments');
                    
                    if (data.comments.length === 0) {
                        container.innerHTML = '<p>아직 댓글이 없습니다.</p>';
                        return;
                    }
                    
                    let html = '<table class="admin-table">';
                    html += '<thead><tr><th>ID</th><th>게시글</th><th>작성자</th><th>댓글 내용</th><th>좋아요</th><th>싫어요</th><th>작성시간</th><th>관리</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.comments.forEach(comment => {
                        const date = new Date(comment.created_at);
                        const formattedDate = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                        
                        html += `<tr>
                            <td>${comment.id}</td>
                            <td><a href="/content/${comment.content_id}" target="_blank">${comment.content_subject || '제목 없음'}</a></td>
                            <td>${comment.nickname}</td>
                            <td>${comment.comment_text.length > 50 ? comment.comment_text.substring(0, 50) + '...' : comment.comment_text}</td>
                            <td>${comment.likes}</td>
                            <td>${comment.dislikes}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <button class="btn-delete" onclick="deleteComment(${comment.id})">삭제</button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('댓글 로드 실패:', error);
                document.getElementById('recentComments').innerHTML = '<p>댓글을 불러오는데 실패했습니다.</p>';
            }
        }

        // 댓글 삭제
        async function deleteComment(commentId) {
            if (!confirm('이 댓글을 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch(`/admin/api/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('댓글이 삭제되었습니다.');
                    loadRecentComments();
                } else {
                    alert('댓글 삭제에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
                }
            } catch (error) {
                alert('댓글 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 페이지 로드 시 댓글 목록 로드
        document.addEventListener('DOMContentLoaded', loadRecentComments);
    </script>
</body>
</html>