<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="<%= content.subject %> - HI! ISSUE! ì´ìŠˆ ë¸Œë¦¬í•‘ ì„œë¹„ìŠ¤">
    <meta name="keywords" content="<%= content.keyword %>, ìµœì‹  ì´ìŠˆ, íŠ¸ë Œë“œ, ë‰´ìŠ¤">
    <meta property="og:title" content="<%= content.subject %>">
    <meta property="og:description" content="<%= content.content.replace(/<[^>]*>/g, '').substring(0, 150) %>">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://hissue.kr/content/<%= content.id %>">
    <meta property="og:site_name" content="HI! ISSUE!">
    <meta property="article:published_time" content="<%= content.insert_time %>">
    <% if (content.update_time) { %>
    <meta property="article:modified_time" content="<%= content.update_time %>">
    <% } %>
    <% if (content.news_item_picture_1) { %>
    <meta property="og:image" content="<%= content.news_item_picture_1 %>">
    <% } %>
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= content.subject %>">
    <meta name="twitter:description" content="<%= content.content.replace(/<[^>]*>/g, '').substring(0, 150) %>">
    <% if (content.news_item_picture_1) { %>
    <meta name="twitter:image" content="<%= content.news_item_picture_1 %>">
    <% } %>
    
    <!-- ì¶”ê°€ SEO ë©”íƒ€ íƒœê·¸ -->
    <meta name="author" content="HI! ISSUE!">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://hissue.kr/content/<%= content.id %>">
    
    <title><%= content.subject %> - HI! ISSUE!</title>
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5588520972347187"
     crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-area">
                <nav class="nav-menu">
                    <a href="/" class="nav-item active">Hissue AI ì´ìŠˆë¸Œë¦¬í•‘</a>
                    <a href="/coupang" class="nav-item">ì¿ íŒ¡ ê°€ì „ì œí’ˆ í• ì¸ ë² ìŠ¤íŠ¸</a>
                </nav>
            </div>
            <div class="search-area">
                <form action="/" method="get" class="search-form">
                    <div class="search-group">
                        <input type="text" id="search" name="search" placeholder="ê¶ê¸ˆí•œ ì´ìŠˆë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”">
                        <button type="submit">ê²€ìƒ‰</button>
                    </div>
                </form>
            </div>
        </div>
    </header>

    <main>
        <article class="content-detail">
            <h1><%= content.subject %> <span class="comment-count" id="titleCommentCount" style="color: red; font-size: 16px; font-weight: normal;"></span></h1>
            <div class="content-meta">
                <% 
                const insertDate = new Date(content.insert_time);
                const year = insertDate.getFullYear();
                const month = String(insertDate.getMonth() + 1).padStart(2, '0');
                const day = String(insertDate.getDate()).padStart(2, '0');
                const hours = String(insertDate.getHours()).padStart(2, '0');
                const minutes = String(insertDate.getMinutes()).padStart(2, '0');
                const formattedDate = `${year}.${month}.${day} ${hours}:${minutes}`;
                %>
                <span class="date">ì‘ì„±ì¼: <%= formattedDate %></span>
                <span class="views">ì¡°íšŒìˆ˜: <%= content.score %></span>
                <span class="comment-meta" id="metaCommentCount">ëŒ“ê¸€ìˆ˜: 0</span>
            </div>
            
            <div class="content-body">
                <%- content.content %>
            </div>

            <div class="content-navigation">
                <% if (prevId) { %>
                    <a href="/content/<%= prevId %>" class="prev-link">ì´ì „ ê¸€</a>
                <% } %>
                <a href="/" class="list-link">ëª©ë¡ë³´ê¸°</a>
                <% if (nextId) { %>
                    <a href="/content/<%= nextId %>" class="next-link">ë‹¤ìŒ ê¸€</a>
                <% } %>
            </div>

            <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
            <div class="comment-section">
                <h3 class="comment-title">ëŒ“ê¸€ <span class="comment-count" id="totalCommentCount">(0)</span></h3>
                
                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <div class="comment-form">
                    <div class="comment-user-info">
                        <span class="user-nickname" id="userNickname">ë¡œë”©ì¤‘...</span>
                    </div>
                    <div class="comment-input-group">
                        <textarea id="commentText" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" rows="3"></textarea>
                        <button id="submitComment" class="comment-submit-btn">ëŒ“ê¸€ ì‘ì„±</button>
                    </div>
                </div>

                <!-- ë² ìŠ¤íŠ¸ ëŒ“ê¸€ -->
                <div id="bestComments" class="best-comments" style="display: none;">
                    <h4 class="best-comments-title">ë² ìŠ¤íŠ¸ ëŒ“ê¸€</h4>
                    <div id="bestCommentsList"></div>
                </div>

                <!-- ì •ë ¬ ì˜µì…˜ -->
                <div class="comment-sort">
                    <button class="sort-btn active" data-sort="latest">ìµœì‹ ìˆœ</button>
                    <button class="sort-btn" data-sort="likes">ì¢‹ì•„ìš”ìˆœ</button>
                    <button class="sort-btn" data-sort="dislikes">ì‹«ì–´ìš”ìˆœ</button>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div id="commentsList" class="comments-list"></div>
            </div>
        </article>
    </main>

    <script>
    const contentId = <%= content.id %>;
    let currentSort = 'latest';
    let userSessionId = '';

    // ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
    async function loadUserNickname() {
        try {
            const response = await fetch('/api/user/nickname');
            const data = await response.json();
            if (data.success) {
                document.getElementById('userNickname').textContent = data.nickname;
            }
        } catch (error) {
            console.error('ë‹‰ë„¤ì„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
    async function loadComments(sort = 'latest') {
        try {
            const response = await fetch(`/api/comments/${contentId}?sort=${sort}`);
            const data = await response.json();
            
            if (data.success) {
                userSessionId = data.sessionId;
                document.getElementById('totalCommentCount').textContent = `(${data.totalCount})`;
                document.getElementById('titleCommentCount').textContent = data.totalCount > 0 ? `(${data.totalCount})` : '';
                document.getElementById('metaCommentCount').textContent = `ëŒ“ê¸€ìˆ˜: ${data.totalCount}`;
                
                // ë² ìŠ¤íŠ¸ ëŒ“ê¸€ í‘œì‹œ
                if (data.bestComments && data.bestComments.length > 0 && data.bestComments.some(c => c.likes >= 3)) {
                    displayBestComments(data.bestComments.filter(c => c.likes >= 3));
                } else {
                    document.getElementById('bestComments').style.display = 'none';
                }
                
                // ì¼ë°˜ ëŒ“ê¸€ í‘œì‹œ
                displayComments(data.comments);
            }
        } catch (error) {
            console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ë² ìŠ¤íŠ¸ ëŒ“ê¸€ í‘œì‹œ
    function displayBestComments(comments) {
        const container = document.getElementById('bestCommentsList');
        container.innerHTML = '';
        
        comments.slice(0, 3).forEach(comment => {
            container.appendChild(createCommentElement(comment, true));
        });
        
        document.getElementById('bestComments').style.display = 'block';
    }

    // ëŒ“ê¸€ í‘œì‹œ
    function displayComments(comments) {
        const container = document.getElementById('commentsList');
        container.innerHTML = '';
        
        if (comments.length === 0) {
            container.innerHTML = '<p class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>';
            return;
        }
        
        comments.forEach(comment => {
            container.appendChild(createCommentElement(comment, false));
        });
    }

    // ëŒ“ê¸€ ìš”ì†Œ ìƒì„±
    function createCommentElement(comment, isBest) {
        const div = document.createElement('div');
        div.className = 'comment-item' + (isBest ? ' best-comment-item' : '');
        
        const date = new Date(comment.created_at);
        const formattedDate = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        
        const isMyComment = comment.session_id === userSessionId;
        const isLiked = comment.user_vote === 'like';
        const isDisliked = comment.user_vote === 'dislike';
        
        div.innerHTML = `
            <div class="comment-header">
                <span class="comment-author">${comment.nickname}</span>
                <span class="comment-text">${comment.comment_text.replace(/\n/g, '<br>')}</span>
                ${isMyComment ? `<button class="comment-delete" data-id="${comment.id}">ì‚­ì œ</button>` : ''}
            </div>
            <div class="comment-footer">
                <span class="comment-date">${formattedDate}</span>
                <div class="comment-actions">
                    <button class="vote-btn like-btn ${isLiked ? 'active' : ''}" data-id="${comment.id}" data-type="like">
                        <span class="vote-icon">ğŸ‘</span>
                        <span class="vote-count">${comment.likes}</span>
                    </button>
                    <button class="vote-btn dislike-btn ${isDisliked ? 'active' : ''}" data-id="${comment.id}" data-type="dislike">
                        <span class="vote-icon">ğŸ‘</span>
                        <span class="vote-count">${comment.dislikes}</span>
                    </button>
                </div>
            </div>
        `;
        
        return div;
    }

    // ëŒ“ê¸€ ì‘ì„±
    document.getElementById('submitComment').addEventListener('click', async () => {
        const commentText = document.getElementById('commentText').value.trim();
        
        if (!commentText) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contentId: contentId,
                    contentType: 'news',
                    commentText: commentText
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('commentText').value = '';
                loadComments(currentSort);
            } else {
                alert(data.error || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
            alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // ëŒ“ê¸€ ì‚­ì œ
    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('comment-delete')) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const commentId = e.target.dataset.id;
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadComments(currentSort);
                } else {
                    alert(data.error || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    });

    // ì¢‹ì•„ìš”/ì‹«ì–´ìš”
    document.addEventListener('click', async (e) => {
        if (e.target.closest('.vote-btn')) {
            const btn = e.target.closest('.vote-btn');
            const commentId = btn.dataset.id;
            const voteType = btn.dataset.type;
            
            try {
                const response = await fetch(`/api/comments/${commentId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voteType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadComments(currentSort);
                }
            } catch (error) {
                console.error('íˆ¬í‘œ ì‹¤íŒ¨:', error);
            }
        }
    });

    // ì •ë ¬ ë²„íŠ¼
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSort = btn.dataset.sort;
            loadComments(currentSort);
        });
    });

    // ì´ˆê¸° ë¡œë“œ
    loadUserNickname();
    loadComments();
    </script>

    <footer>
        <p>AIë¡œ ì‘ì„±ëœ ê¸€ì…ë‹ˆë‹¤. ì‚­ì œ ë¬¸ì˜: <a href="mailto:today.h.issue@gmail.com">today.h.issue@gmail.com</a></p>
    </footer>
</body>
</html>